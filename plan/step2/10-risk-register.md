# 10 — Реестр рисков

## Формат
`[Вероятность: В/С/Н] [Влияние: В/С/Н]`

---

## R1. Письма попадают в спам
**В/В** — Блокирует получение доступа пользователем.

Митигация:
- [ ] SPF запись настроена для `slodocs.si`
- [ ] DKIM настроен и верифицирован в Brevo
- [ ] DMARC запись добавлена
- [ ] Тест доставляемости на Gmail + Outlook до go-live
- [ ] В письме: без спам-триггеров («бесплатно», «кликни сейчас»)
- [ ] From-domain = аутентифицированный домен (не brevo.com)

Запасной план: ручной ресенд через Filament (Accesses → «Отправить email»).

---

## R2. Webhook дублирует доступ
**С/В** — Пользователь получает два Access, путаница с токенами.

Митигация:
- [ ] Cache-дедупликация по `event_id` в WebhookController (24 ч)
- [ ] Проверка `Access::where('purchase_id', ...)->exists()` в AccessGrantService
- [ ] Тест сценария «повторный webhook» из 06-qa-scenarios.md пройден
- [ ] `payment_id` уникален в таблице `purchases`

---

## R3. Деплой ломает конфиги или кеш
**С/С** — Сайт не работает после деплоя.

Митигация:
- [ ] Фиксированный deploy checklist (08-ops-and-maintenance.md O1)
- [ ] После каждого деплоя — `nginx -t` перед reload
- [ ] `php artisan config:cache` только после проверки `.env`
- [ ] `route:cache` — убедиться что `/webhooks/stripe` в списке роутов

Запасной план: `git revert` + `php artisan config:clear` + restart.

---

## R4. Stripe webhook не приходит
**С/В** — Оплата прошла, Access не выдан.

Митигация:
- [ ] Webhook endpoint в Stripe Dashboard указывает на правильный URL
- [ ] `/webhooks/stripe` исключён из Basic Auth (nginx конфиг)
- [ ] CSRF исключение для webhook настроено в `bootstrap/app.php`
- [ ] Signature verification не падает (STRIPE_WEBHOOK_SECRET актуален)
- [ ] Stripe Dashboard → Webhooks → Events — проверять статус доставки

Запасной план: Stripe Dashboard → выбрать событие → Resend.

---

## R5. Контент сложно написать
**В/С** — Задержка запуска.

Митигация:
- [ ] MVP-формат: 4–6 шагов, только практическое (05-content-mvp.md)
- [ ] Роль «редактор», не «автор»: собрать существующую информацию, не писать с нуля
- [ ] Claude-задача T-06 для генерации черновика
- [ ] Начать с одной услуги (school-enrollment уже есть)

---

## R6. Файлы доступны без авторизации
**Н/В** — Утечка платного контента.

Митигация:
- [ ] Все PDF в `storage/app/private` (не в `public/`)
- [ ] FileController проверяет токен перед отдачей файла
- [ ] Whitelist полей в FileController (не произвольный путь)
- [ ] Тест: прямой URL файла без токена → 403/404 (сценарий F1 в 06-qa-scenarios.md)

---

## R7. Queue worker упал, jobs не обрабатываются
**С/С** — Email не отправляется, Access не выдаётся.

Митигация:
- [ ] Systemd `Restart=always` для queue worker
- [ ] Failed jobs попадают в `failed_jobs` таблицу
- [ ] Sentry алертит при необработанных ошибках
- [ ] Ежемесячная проверка `php artisan queue:failed`

Запасной план: `systemctl restart slodocs-worker` + `php artisan queue:retry all`.

---

## R8. PostgreSQL недоступен
**Н/В** — Сайт полностью не работает.

Митигация:
- [ ] PostgreSQL на том же сервере (нет сетевой зависимости)
- [ ] Systemd `Restart=always` для postgresql
- [ ] Ежедневные бэкапы (08-ops-and-maintenance.md O3)
- [ ] Мониторинг через Sentry (5xx ошибки)

---

## R9. Пользователь потерял ссылку с токеном
**В/Н** — Обращение в поддержку.

Митигация:
- [ ] В письме явно написано «сохраните эту ссылку»
- [ ] Filament → Accesses → повторная отправка email (без ограничений для админа)
- [ ] Rate limit на ресенд только для автоматических запросов, не для админа

---

## Сводная таблица

| # | Риск | Вер. | Влиян. | Статус |
|---|------|------|--------|--------|
| R1 | Письма в спам | В | В | Митигировано (SPF/DKIM) |
| R2 | Дубль webhook | С | В | Митигировано (idempotency) |
| R3 | Деплой ломает конфиг | С | С | Митигировано (checklist) |
| R4 | Webhook не приходит | С | В | Митигировано (Stripe resend) |
| R5 | Контент сложно писать | В | С | Митигировано (MVP-формат) |
| R6 | Файлы без авторизации | Н | В | Митигировано (FileController) |
| R7 | Worker упал | С | С | Митигировано (systemd) |
| R8 | PostgreSQL недоступен | Н | В | Мониторинг (Sentry) |
| R9 | Пользователь потерял ссылку | В | Н | Ресенд через админку |
