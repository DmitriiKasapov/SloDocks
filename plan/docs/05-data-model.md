# Data Model — SloDocs (MVP)

## Назначение документа
Зафиксировать минимальную модель данных для MVP:
- услуги
- оплаты
- доступ к материалам
- базовую статистику

Документ используется как:
- основа для миграций
- ориентир для backend-логики
- источник правды для ИИ при генерации кода

---

## Общие принципы

- минимальное количество таблиц
- отсутствие пользовательских аккаунтов и авторизации
- email — основной идентификатор доступа
- доступ ограничен по времени
- данные не дублируются
- модель допускает расширение после MVP

---

## Сущности и связи (обзор)

- Service (услуга)
- Purchase (покупка)
- Access (доступ)
- User (пользователь — пассивная сущность)
- ActivityLog (журнал событий)

Связи:
- одна услуга → много покупок
- одна покупка → один доступ
- один email → может иметь несколько доступов (к разным услугам)
- пользователь может быть связан с покупками по email
- события могут быть связаны с услугой, покупкой и email

---

## Service (Услуга)

**Назначение:**  
Хранение информации об услуге и её публичном описании.

**Основные поля:**
- id
- slug (для URL)
- title
- description_public
- price
- access_duration_days
- is_active
- created_at
- updated_at

**Примечания:**
- `slug` уникальный
- `description_public` используется для SEO
- `is_active` позволяет скрывать услугу без удаления

---

## Purchase (Покупка)

**Назначение:**  
Фиксация факта оплаты и её статуса.

**Основные поля:**
- id
- service_id
- email
- payment_provider
- payment_id (уникальный идентификатор у провайдера)
- amount
- currency
- status (pending / paid / failed)
- created_at
- updated_at

**Примечания:**
- `payment_id` используется для идемпотентности
- статус `paid` — единственный, при котором создаётся доступ

---

## Access (Доступ)

**Назначение:**  
Контроль доступа к платному контенту услуги.

**Основные поля:**
- id
- service_id
- purchase_id
- email
- access_token
- starts_at
- expires_at
- is_active
- created_at
- updated_at

**Примечания:**
- `access_token` используется для входа по ссылке
- `expires_at` определяет окончание доступа
- `is_active` позволяет вручную отключить доступ
- доступ не зависит от наличия пользователя

---

## User (Пользователь — пассивная сущность)

**Назначение:**  
Хранение агрегированной информации о пользователях
для статистики и возможного расширения в будущем.

**Основные поля:**
- id
- email
- first_purchase_at
- last_purchase_at
- purchases_count
- created_at
- updated_at

## Пользовательская статистика (агрегированная)

- связь email → оплаченные услуги
- количество покупок на email
- даты первой и последней покупки
- отсутствие трекинга действий внутри контента

**Примечания:**
- пользователь создаётся автоматически при первой покупке
- email уникален
- User не используется для авторизации
- User не участвует в логике доступа в MVP

---

## ActivityLog (Audit Log — минимальный)

**Назначение:**  
Фиксация ключевых пользовательских и системных событий
для статистики, диагностики и анализа воронки.

**Основные поля:**
- id
- event_type
- email (nullable)
- service_id (nullable)
- purchase_id (nullable)
- metadata (json)
- created_at

---

## Логируемые события (MVP)

- service_viewed
- payment_started
- payment_success
- payment_failed
- access_granted
- access_expired

**Примечания:**
- логируются только ключевые события
- лог не используется для маркетинга
- лог не используется для персонализации
- отсутствует UI для просмотра логов в MVP

---

## Логика создания доступа

1. Пользователь инициирует оплату
2. Создаётся запись Purchase со статусом `pending`
3. Платёжный провайдер подтверждает оплату (webhook)
4. Purchase переводится в статус `paid`
5. Создаётся Access:
   - email копируется из Purchase
   - срок доступа рассчитывается автоматически
6. Обновляется или создаётся User
7. Фиксируется событие `access_granted`
8. Пользователю отправляется email с ссылкой доступа

---

## Логика проверки доступа

Доступ считается валидным, если:
- Access существует
- is_active = true
- текущая дата < expires_at

В противном случае:
- платный контент не отображается
- показывается сообщение об окончании доступа
- фиксируется событие `access_expired`

---

## Что осознанно отсутствует в модели

- регистрация, пароли и авторизация пользователей
- роли и права
- личный кабинет пользователя
- детальный поведенческий трекинг (клики, скроллы, heatmap, session replay)
- прогресс прохождения материалов
- комментарии и отзывы
- скидки и промокоды

---

## Расширение модели (после MVP)

Возможные будущие сущности:
- Subscription
- ServiceCategory
- ContentVersion
- UserSession
- PaymentRetry

⚠️ Эти сущности не используются и не учитываются в MVP.