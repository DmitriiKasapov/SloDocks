Платный доступ к контенту
1. Цель документа

Описать архитектуру платного доступа к контенту услуг. Документ служит:

источником правды для реализации

ориентиром для frontend / backend

защитой от архитектурных ошибок (глобальный доступ, утечки контента)

Проект: Laravel (Blade) + Tailwind CSS + Alpine.js Фаза: MVP (без логина и личного кабинета)

2. Базовые принципы

Контент услуг не отображается на странице услуги

Контент доступен только на отдельной скрытой странице

Каждая покупка = отдельный доступ

Доступ всегда привязан к конкретной услуге

Нет глобального доступа

Нет контента без серверной проверки

❗ Безопасность обеспечивается архитектурой, а не UI

3. Роли страниц
3.1 Страница услуги

URL: /services/{slug}

Назначение:

продажа услуги

информирование клиента

Содержит:

краткое описание

преимущества

CTA «КУПИТЬ»

НЕ содержит:

полный контент услуги

RichText-материалы

Динамическое поведение:

если доступ есть → кнопка покупки скрыта

если доступа нет → стандартный CTA

3.2 Скрытая страница контента

URL: /access/{token}

Назначение:

отображение платного контента

Правила:

доступ только по валидному token

контент загружается только после проверки доступа

Поведение:

невалидный token → 404

отключённый доступ → 404

4. Модель доступа
4.1 Таблица accesses

Каждая покупка создаёт одну запись в таблице accesses.

Минимальные поля:

id

service_id

email

token

is_active

created_at

expires_at (опционально, на будущее)

❗ Никаких полей вида has_access

4.2 Связь данных

accesses.service_id → services.id

один access относится к одной услуге

один пользователь может иметь несколько access-записей

5. Ключевое правило безопасности

❗ Доступ проверяется ТОЛЬКО по service_id

❌ Запрещено
if ($hasAccess) { ... }
✅ Разрешено
hasAccess(service_id, email)
6. Проверка доступа
6.1 Универсальная проверка
Access::where('service_id', $service->id)
    ->where('email', $email)
    ->where('is_active', true)
    ->exists();

true → доступ есть только к этой услуге

false → доступа нет

Наличие других access-записей не влияет.

7. Поведение страницы услуги
Если доступ есть

кнопка «КУПИТЬ» скрыта

показывается блок:

«У вас уже есть доступ к этой услуге»

кнопка «Перейти к материалам»

Если доступа нет

стандартный CTA «КУПИТЬ»

8. Поток после оплаты (Stripe)
8.1 Webhook

Stripe webhook выполняет:

создание записи в accesses

генерацию token

сохранение email и service_id

8.2 Клиентский доступ

Клиент получает:

email со ссылкой /access/{token}

или redirect на эту страницу после оплаты

9. Использование сессии
Допустимо

хранить email

Запрещено

хранить глобальный флаг доступа

has_access = true // ❌
Опционально
has_access_service_{id} = true

(но предпочтительно проверять доступ через БД)

10. RichText и контент

Контент хранится в БД

Рендерится сервером (Blade)

Никогда не отдаётся без проверки access

Запрещено

публичные PDF

публичные файлы в storage/public

iframe с прямыми ссылками

❗ 100% защиты от копирования не существует Архитектура предотвращает несанкционированный доступ

11. Почему без логина (MVP)

ниже порог входа

выше конверсия

меньше поддержки

быстрее разработка

Логин и кабинет — этап 2+.

12. Будущее развитие (НЕ в MVP)

magic-login

личный кабинет

подписки

роли

ограничение по времени

13. Резюме (обязательные правила)

нет глобального доступа

каждая услуга изолирована

нет контента без проверки

один token = одна услуга

Нарушение любого пункта = архитектурная ошибка
