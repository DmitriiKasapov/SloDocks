# Правила работы Claude в проекте

1. Язык общения
 - Всё общение с разработчиком — ТОЛЬКО на русском языке.
 - Все объяснения, рассуждения, предупреждения и инструкции — ТОЛЬКО на русском.
 - Комментарии в коде — ВСЕГДА на английском языке.
 - Комментарии в коде на русском языке ЗАПРЕЩЕНЫ.

2. Общее поведение
 - Работай аккуратно и консервативно.
 - НЕ меняй поведение приложения, если это прямо не запрошено.
 - НЕ вноси ломающие изменения.
 - Отвечай коротко.

3. Правила изменения кода
 - Вся документация по проекту находится в папке app/plan.
 - app/plan/plan.md — основное руководство для разработки. Всегда сверяйся с ним.
 - app/plan/ended.md — файл отчёта о выполнении. Сверяйся с ним. По окончании этапов вноси дополнения о завершённой работе.

4. Сводка: plan/generals
Технологический стек
 - Backend: Laravel
 - Frontend: Blade + Tailwind CSS
 - JavaScript: минимальный, Alpine.js — по необходимости

База данных: MySQL или PostgreSQL

Платежи: Stripe

Email: SMTP

Хостинг: VPS (Hetzner / DigitalOcean)

Окружение

 - Два окружения: local и production (без staging)

 - Все секреты хранятся в .env и не коммитятся

 - Основные группы переменных: APP, DB, SESSION, PAYMENT, MAIL, FILE STORAGE, LOG, RATE_LIMIT
 - Файлы без публичных URL — доступны только через backend
 - Токены доступа генерируются сервером, длительность переопределяется на уровне услуги
 - НЕ используются: secret-менеджеры, очереди, staging, сложная инфраструктура

Деплой

 - Деплой ручной, автоматизация не требуется для MVP
 - Разные ключи для разных окружений
 - Email для сервисных уведомлений (ссылки доступа, оплата, окончание срока)
 - Хостинг определяется после выбора стека и может меняться без влияния на продукт

5. Сводка: plan/docs
01 — Идея и концепция

 - plan/docs/01-idea-concept.md
 - SloDocs — платный информационный портал для русскоязычных иностранцев в Словении
 - ЦА: планирующие переезд или недавно переехавшие
 - Формат: выбрал услугу → оплатил → получил доступ (без общения)
 - Доступ ограничен по сроку и предоставляется через сайт
 - Первая услуга: оформление ребёнка в школу
 - НЕ входит: консультации, юридические услуги, гарантии результата
 - Критерий успеха: 20 оплат за 2 месяца

02 — Пользовательский поток

 - plan/docs/02-user-flow.md
 - Главная → список услуг → страница услуги → описание → кнопка «Получить доступ» → оплата → доступ к материалам
 - При ошибке оплаты: уведомление + возможность повторить
 - По истечении срока система автоматически закрывает доступ

03 — Границы MVP

 - plan/docs/03-mvp-boundaries.md
 - Одна услуга, одна страница, онлайн-оплата, автоматический доступ
 - Безопасность: HTTPS, закрытый контент, семантический HTML, SEO (schema.org, sitemap, robots.txt)
 - Бизнес-логика вне шаблонов, тонкие контроллеры
 - При ошибке оплаты — доступ не выдаётся
 - При ошибке email — доступ сохраняется
  - НЕ входит: личный кабинет, регистрация, поиск, отзывы, скидки, мобильное приложение
 - Юридические страницы: Условия использования, Политика конфиденциальности

04 — Структура услуги

 - plan/docs/04-service-structure.md
 - Услуга = публичная часть + платная часть + логика доступа
 - Публичная часть: заголовок (H1), описание (2–4 абзаца), состав материалов, цена, CTA, отказ от ответственности
 - Платная часть (после оплаты): пошаговая инструкция, список документов, бланки/образцы, практические советы
 - Доступ по email + access_token, повторный вход по ссылке из email
 - До оплаты: платный контент скрыт, без размытых текстов

05 — Модель данных

 - plan/docs/05-data-model.md
 - Сущности: Service, Purchase, Access, User (пассивная), ActivityLog
 - Service: slug, title, description_public, price, access_duration_days, is_active
 - Purchase: service_id, email, payment_id (идемпотентность), status (pending / paid / failed)
 - Access: access_token, starts_at, expires_at, is_active — не зависит от User
 - User: создаётся автоматически при первой покупке, email уникален, не используется для авторизации
 - ActivityLog: service_viewed, payment_started / success / failed, access_granted / expired
 - Логика: webhook → Purchase = paid → создаётся Access → User обновляется → email со ссылкой

06 — Логика доступа

 - plan/docs/06-access-logic.md
 - Доступ без регистрации, привязан к email + access_token, ограничен по сроку
 - Проверка на каждом запросе: token существует, Access существует, is_active = true, текущая дата < expires_at
 - Ссылка: /services/{slug}?token=ACCESS_TOKEN
 - Повторный webhook не создаёт дубликат
 - Повторная покупка — новый Access (не продление)
 - Email не доставлен — доступ всё равно создаётся
 - Файлы вне public/, доступ только через проверку Access
 - Логика доступа — в middleware / сервисе, не в шаблонах

07 — Платёжный поток

 - plan/docs/07-payment-flow.md
 - Stripe Checkout Session (hosted), тестовый и боевой режимы разделены
 - Инициализация: кнопка → запрос email → Purchase (pending) → Stripe session → редирект
 - Успех: webhook payment_intent.succeeded → проверка подписи → Purchase = paid → Access
 - Ошибка: Stripe сообщает пользователю, webhook payment_failed, Purchase = failed
 - Идемпотентность: payment_id обрабатывается один раз
 - Безопасность: проверка подписи webhook, проверка суммы, frontend не влияет на статус
 - Возврат: только вручную через Stripe Dashboard
 - НЕ реализовано: подписки, автопродление, рассрочки

08 — Админка (scope)

 - plan/docs/08-admin-scope.md
 - Один администратор (владелец проекта), без ролей
 - Может: создавать и редактировать услуги, управлять контентом, смотреть оплаты (только чтение), деактивировать доступ, овторно отправлять email
 - Статистика: количество покупок, активных доступов, пользователей (без графиков)
 - НЕ может: управлять платежами, менять статусы, создавать других администраторов, управлять скидками
 - Админка закрыта от индексации, защищена, все действия логируются

09 — Админка (поля)

 - plan/docs/09-admin-fields.md
 - Service: title, slug, description_public, price, access_duration_days, is_active
 - Контентные блоки: инструкция, документы (PDF бланки + образцы), список ссылок, практические советы
 - Файлы без публичных URL, количество не ограничено
 - Медиа (MVP+): изображения, карта — необязательно
 - Пользователи: только просмотр (email, сумма, количество покупок)
 - Изменение контента или цены не влияет на уже выданные доступы

10 — Безопасность и защита от злоупотреблений

 - plan/docs/10-security-and-abuse.md
 - Платежи: подпись webhook, идемпотентность, статус только по webhook, frontend не влияет
 - Доступ: длинный случайный access_token, серверная проверка, файлы через backend
 - Rate limiting: на оплату, на запросы доступа, на email-отправки
 - Защита от перебора токенов, логирование невалидных попыток
 - Админка: закрыта, не индексируется, логируется
 - НЕ реализуется: DRM, watermarking, fingerprinting, CAPTCHA везде
