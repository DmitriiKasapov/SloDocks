# Схема структуры Service и ServiceContent

## До рефакторинга

```
┌─────────────────────────────────────────┐
│            SERVICES TABLE               │
├─────────────────────────────────────────┤
│ id                                      │
│ slug                                    │
│ title                                   │
│ category_id                             │
│ description_public                      │
│                                         │
│ ┌─────────────────────────────────┐   │
│ │    CONTENT (в той же таблице)    │   │
│ ├─────────────────────────────────┤   │
│ │ content                          │   │
│ │ image                            │   │
│ │ hidden_text_1                    │   │
│ │ hidden_file_path_1               │   │
│ │ hidden_file_path_2               │   │
│ │ hidden_links                     │   │
│ │ hidden_text_2                    │   │
│ │ hidden_image                     │   │
│ └─────────────────────────────────┘   │
│                                         │
│ price                                   │
│ access_duration_days                    │
│ seo_title                               │
│ seo_description                         │
│ is_active                               │
└─────────────────────────────────────────┘
```

## После рефакторинга

```
┌──────────────────────────┐         ┌────────────────────────────────┐
│    SERVICES TABLE        │         │   SERVICE_CONTENTS TABLE       │
├──────────────────────────┤         ├────────────────────────────────┤
│ id                       │◄────┐   │ id                             │
│ slug                     │     └───┤ service_id (FK)                │
│ title                    │         │                                │
│ category_id              │         │ ┌────────────────────────────┐ │
│ description_public       │         │ │   PUBLIC CONTENT           │ │
│                          │         │ ├────────────────────────────┤ │
│ price                    │         │ │ content                    │ │
│ access_duration_days     │         │ │ image                      │ │
│                          │         │ └────────────────────────────┘ │
│ seo_title                │         │                                │
│ seo_description          │         │ ┌────────────────────────────┐ │
│ is_active                │         │ │   HIDDEN CONTENT           │ │
│                          │         │ ├────────────────────────────┤ │
│ created_at               │         │ │ hidden_text_1              │ │
│ updated_at               │         │ │ hidden_file_path_1         │ │
└──────────────────────────┘         │ │ hidden_file_path_2         │ │
                                     │ │ hidden_links (JSON)        │ │
                                     │ │ hidden_text_2              │ │
                                     │ │ hidden_image               │ │
                                     │ └────────────────────────────┘ │
                                     │                                │
                                     │ status (draft/published)       │
                                     │ created_at                     │
                                     │ updated_at                     │
                                     └────────────────────────────────┘
```

## Отношения (Relationships)

```
Service (1) ──hasOne──> ServiceContent (1)
            <──belongsTo──
```

## Структура админки Filament

```
┌─────────────────────────────────────────────────────────┐
│                    SERVICE EDIT PAGE                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌────────────┬──────────────┬────────────┐           │
│  │  Основное  │  Материалы   │   Доступ   │           │
│  └────────────┴──────────────┴────────────┘           │
│                                                         │
│  ┌───────────────────────────────────────────────┐    │
│  │           TAB: ОСНОВНОЕ                       │    │
│  ├───────────────────────────────────────────────┤    │
│  │                                               │    │
│  │  • Название                                   │    │
│  │  • Slug                                       │    │
│  │  • Категория                                  │    │
│  │  • Теги (2-5)                                 │    │
│  │  • Краткое описание                           │    │
│  │  • Цена                                       │    │
│  │  • Доступ (дни)                               │    │
│  │  • Активна                                    │    │
│  │                                               │    │
│  │  ▼ SEO (collapsed)                            │    │
│  │     • SEO Title                               │    │
│  │     • SEO Description                         │    │
│  │                                               │    │
│  └───────────────────────────────────────────────┘    │
│                                                         │
│  ┌───────────────────────────────────────────────┐    │
│  │           TAB: МАТЕРИАЛЫ                      │    │
│  ├───────────────────────────────────────────────┤    │
│  │                                               │    │
│  │  ┌─ Публичный контент ──────────────────┐   │    │
│  │  │  • Текст страницы (RichEditor)       │   │    │
│  │  │  • Изображение                       │   │    │
│  │  └──────────────────────────────────────┘   │    │
│  │                                               │    │
│  │  ▼ Скрытый контент (collapsed)                │    │
│  │     • Инструкция (RichEditor)                 │    │
│  │     • Документ PDF (1)                        │    │
│  │     • Документ PDF (2)                        │    │
│  │     • Список ссылок (Repeater)                │    │
│  │     • Практические советы (RichEditor)        │    │
│  │     • Изображение (скрытое)                   │    │
│  │     • Статус (draft/published)                │    │
│  │                                               │    │
│  └───────────────────────────────────────────────┘    │
│                                                         │
│  ┌───────────────────────────────────────────────┐    │
│  │           TAB: ДОСТУП                         │    │
│  ├───────────────────────────────────────────────┤    │
│  │                                               │    │
│  │  (Будет реализовано позже)                   │    │
│  │   - Список покупок                            │    │
│  │   - Активные доступы                          │    │
│  │   - Статистика                                │    │
│  │                                               │    │
│  └───────────────────────────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Поток данных при создании услуги

```
1. User заполняет форму
   ↓
2. CreateService::mutateFormDataBeforeCreate()
   • Извлекает content.*
   • Сохраняет в $contentData
   • Возвращает данные Service
   ↓
3. Service сохраняется
   ↓
4. CreateService::afterCreate()
   • Создаёт ServiceContent с $contentData
   • Связывает через service_id
   ↓
5. Готово!
```

## Поток данных при редактировании услуги

```
1. EditService::mutateFormDataBeforeFill()
   • Загружает $service->content
   • Добавляет в data['content']
   ↓
2. User видит заполненную форму
   ↓
3. User редактирует и сохраняет
   ↓
4. EditService::mutateFormDataBeforeSave()
   • Извлекает content.*
   • Сохраняет в $contentData
   • Возвращает данные Service
   ↓
5. Service обновляется
   ↓
6. EditService::afterSave()
   • Обновляет или создаёт ServiceContent
   ↓
7. Готово!
```

## Использование в Blade

```
┌────────────────────────────────────────┐
│         ServiceController              │
├────────────────────────────────────────┤
│  $service = Service::with('content')   │
│              ->find($id);              │
└────────────────┬───────────────────────┘
                 │
                 ↓
┌────────────────────────────────────────┐
│         services/show.blade.php        │
├────────────────────────────────────────┤
│  {{ $service->title }}                 │
│  {{ $service->description_public }}    │
│                                        │
│  @if($service->content)                │
│    {!! $service->content->content !!}  │
│  @endif                                │
└────────────────────────────────────────┘
```

## Миграции

```
Порядок выполнения:

1. 2026_02_01_100001_create_service_contents_table.php
   • Создаёт таблицу service_contents
   ↓
2. 2026_02_01_100002_migrate_service_content_data.php
   • Копирует данные services → service_contents
   ↓
3. 2026_02_01_100003_drop_content_fields_from_services.php
   • Удаляет старые поля из services
   ↓
✅ Готово!
```

## Откат миграций

```
php artisan migrate:rollback --step=3

3. Восстанавливает поля в services
   ↓
2. Переносит данные service_contents → services
   ↓
1. Удаляет таблицу service_contents
   ↓
✅ Вернулись к старой структуре
```
