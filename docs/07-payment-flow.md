# Payment Flow — SloDocs (MVP)

## Назначение документа
Зафиксировать логику оплаты в MVP:
- как инициируется платёж
- как подтверждается оплата
- как обрабатываются ошибки
- как обеспечивается безопасность и защита от ботов

Документ используется как:
- источник правды для платёжной логики
- основа для реализации Stripe/webhooks
- инструкция для ИИ при генерации кода

---

## Общие принципы оплаты

- оплата осуществляется через стороннего платёжного провайдера
- платёжные данные не хранятся на стороне сервиса
- сервис не реализует собственные платёжные формы
- вся логика оплаты отделена от логики доступа

---

## Платёжный провайдер

- используется Stripe
- используется hosted checkout (Stripe Checkout Session)
- тестовый и боевой режимы разделены

Причины выбора:
- встроенная защита от фрода
- защита от ботов
- надёжные webhooks
- соответствие требованиям безопасности

---

## Инициация платежа

### Условия инициации
Платёж может быть инициирован, если:
- услуга существует
- услуга активна (`is_active = true`)
- цена услуги определена
- email пользователя передан и валиден

---

### Процесс инициации

1. Пользователь нажимает кнопку «Получить доступ»
2. Система запрашивает email (если не передан ранее)
3. Создаётся запись Purchase со статусом `pending`
4. Создаётся Stripe Checkout Session
5. Пользователь перенаправляется на страницу оплаты Stripe

---

## Поведение на стороне Stripe

- пользователь вводит платёжные данные на стороне Stripe
- сервис не имеет доступа к данным карты
- Stripe выполняет:
  - антифрод-проверки
  - защиту от ботов
  - валидацию платежа

---

## Завершение платежа (Happy Path)

1. Пользователь успешно оплачивает
2. Stripe отображает страницу успешной оплаты
3. Stripe отправляет webhook `payment_intent.succeeded`
4. Система:
   - проверяет подпись webhook
   - находит Purchase по `payment_id`
   - проверяет, что Purchase ещё не обработан
5. Purchase переводится в статус `paid`
6. Фиксируется событие `payment_success`
7. Передаётся управление логике выдачи доступа (см. `06-access-logic.md`)

---

## Обработка ошибок оплаты

### Возможные ошибки

- недостаточно средств
- ошибка карты
- отмена пользователем
- техническая ошибка Stripe

---

### Поведение системы

1. Stripe отображает сообщение об ошибке пользователю
2. Stripe отправляет webhook `payment_intent.payment_failed`
3. Purchase переводится в статус `failed`
4. Фиксируется событие `payment_failed`
5. Пользователь может:
   - повторить оплату
   - вернуться на страницу услуги

---

## Доступ после оплаты

- после успешной оплаты пользователь перенаправляется на страницу подтверждения
- при подтверждённой оплате доступ открывается сразу на сайте
- ссылка на доступ также отправляется на email
- email используется как резервный способ повторного доступа

---

## Повторные попытки оплаты

- повторная попытка создаёт **новый** Checkout Session
- один Purchase не переиспользуется для повторной оплаты
- повторные попытки не создают доступ

---

## Идемпотентность и защита от дублей

- каждый `payment_id` обрабатывается один раз
- повторные webhook-события игнорируются
- одна успешная оплата → один Access

---

## Безопасность платежей

- проверка подписи всех webhook-событий
- отказ от обработки неподписанных запросов
- проверка соответствия суммы оплате услуги
- невозможность изменить цену на клиентской стороне

---

## Защита от ботов и злоупотреблений

### Реализуемые меры

- использование Stripe hosted checkout
- rate limiting на:
  - создание платёжных сессий
  - повторные попытки оплаты
- защита от массовых запросов с одного IP
- отсутствие собственных форм оплаты

### Осознанно не используется

- CAPTCHA на стороне сервиса
- fingerprinting пользователей
- сложные антибот-системы

---

## Логирование и события

Логируются события:
- payment_started
- payment_success
- payment_failed

Логи используются для:
- диагностики
- анализа воронки
- выявления проблем

---

## Возвраты и отмены (MVP)

- автоматические возвраты не реализуются
- ручные возвраты возможны через Stripe Dashboard
- возвраты не восстанавливают доступ автоматически

---

## Edge cases

### Повторный webhook
- не создаёт повторную покупку
- не создаёт повторный доступ

### Пользователь закрыл страницу Stripe
- Purchase остаётся в статусе `pending`
- доступ не выдаётся

### Несоответствие суммы
- платёж отклоняется
- событие логируется

---

## Что осознанно отсутствует

- подписки
- автопродление
- частичные платежи
- рассрочки
- сложная антифрод-логика

---

## Итог

Платёжная логика:
- безопасная
- изолированная
- масштабируемая
- не хранит чувствительные данные
- полностью соответствует MVP Boundaries

Документ считается зафиксированным для MVP.