# Access Logic — SloDocs (MVP)

## Назначение документа
Описать логику предоставления и проверки доступа к платному контенту услуги:
- как доступ выдаётся
- как проверяется
- как истекает
- как система ведёт себя в edge cases

Документ используется как:
- источник правды для backend-логики
- основа для middleware и контроллеров
- инструкция для ИИ при генерации кода

---

## Общие принципы доступа

- доступ предоставляется **без регистрации и авторизации**
- доступ привязан к **email и access_token**
- доступ ограничен **по сроку**
- платный контент **никогда не доступен по публичным URL**
- доступ проверяется **на каждом запросе** к платному контенту

---

## Типы доступа

### Публичный доступ
- доступен без оплаты
- индексируется поисковыми системами
- включает:
  - описание услуги
  - состав материалов
  - цену и условия
  - отказ от ответственности

### Платный доступ
- доступен только после оплаты
- закрыт от индексации
- включает:
  - инструкции
  - документы
  - бланки
  - образцы
  - практические советы

---

## Выдача доступа (после оплаты)

### Условия выдачи
Доступ выдаётся, если:
- платёж подтверждён провайдером
- Purchase имеет статус `paid`
- доступ по данной покупке ещё не создан

---

### Процесс выдачи

1. Получено webhook-событие от платёжного провайдера
2. Проверяется уникальность `payment_id`
3. Purchase переводится в статус `paid`
4. Создаётся Access:
   - генерируется `access_token`
   - устанавливается `starts_at`
   - рассчитывается `expires_at`
   - `is_active = true`
5. Обновляется или создаётся User
6. Логируется событие `access_granted`
7. Отправляется email со ссылкой доступа

---

## Формат ссылки доступа

- ссылка содержит `access_token`
- токен:
  - случайный
  - достаточно длинный
  - не угадываемый
- пример:
/services/{slug}?token=ACCESS_TOKEN

yaml
Копировать код

---

## Проверка доступа (на каждом запросе)

Доступ считается валидным, если:
- access_token передан
- Access существует
- Access.is_active = true
- текущая дата < Access.expires_at

Если хотя бы одно условие не выполнено — доступ невалиден.

---

## Поведение при невалидном доступе

### Сценарии

#### 1. Нет токена
- отображается публичная версия страницы
- платный контент скрыт
- показывается CTA на оплату

#### 2. Токен не найден / неверный
- отображается сообщение об ошибке доступа
- без деталей причины

#### 3. Срок доступа истёк
- платный контент скрыт
- отображается сообщение:
  - «Срок доступа истёк»
- логируется событие `access_expired`

#### 4. Access.is_active = false
- доступ закрыт
- отображается нейтральное сообщение

---

## Поведение при повторном доступе

- пользователь может переходить по ссылке доступа
- доступ действует до `expires_at`
- количество посещений не ограничено
- нет сессий и сохранения состояния

---

## Edge cases (обязательно)

### Повторный webhook
- не создаётся повторный доступ
- логика идемпотентна

### Email не доставлен
- доступ всё равно создан
- повторная отправка возможна вручную
- пользователь может повторно запросить ссылку

### Покупка одной и той же услуги повторно
- создаётся новый Access
- старый доступ не продлевается автоматически
- оба доступа существуют независимо

---

## Ограничения и защита

- отсутствие прямых ссылок на файлы
- файлы хранятся вне public/
- доступ к файлам только через проверку Access
- отсутствие возможности перебора токенов

---

## Middleware / слой доступа (логически)

- вся логика проверки доступа вынесена в middleware или сервис
- шаблоны не содержат проверок доступа
- контроллеры не дублируют логику

---

## Логирование событий

Логируются события:
- access_granted
- access_expired
- access_denied (опционально)

Логи используются только для:
- диагностики
- статистики
- анализа воронки

---

## Что осознанно отсутствует

- личные кабинеты
- авторизация
- refresh-ссылки
- продление доступа
- ограничение по устройствам
- DRM и защита от скриншотов

---

## Итог

Логика доступа:
- простая
- надёжная
- масштабируемая
- не требует аккаунтов
- соответствует MVP Boundaries

Документ считается зафиксированным для MVP.